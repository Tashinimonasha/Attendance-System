<!DOCTYPE html>
<html lang="en">
<head>  <meta charset="UTF-8" />
  <title>Attendance OCR - Printcare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
      background-size: cover;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 50, 0.6);
      z-index: -1;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center px-6 py-10 text-white font-sans">
  <h1 class="text-6xl font-extrabold mb-12 text-center drop-shadow-lg">
    Welcome to <span class="text-yellow-400">Printcare</span>
  </h1>
  
  <!-- Flash Messages for Logout Success -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if category == 'success' %}
          <div id="logoutMessage" class="mb-6 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-xl shadow-lg flex items-center justify-center max-w-md">
            <i class="fas fa-check-circle mr-2"></i>
            {{ message }}
            <button onclick="closeLogoutMessage()" class="ml-4 text-green-500 hover:text-green-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- Admin Dashboard Link -->
  <div class="mb-6">
    <a href="/admin" class="bg-gray-800 bg-opacity-70 hover:bg-opacity-90 text-white px-6 py-3 rounded-xl font-semibold transition duration-200 shadow-lg">
      üîß Admin Dashboard
    </a>
  </div>
  
  <div class="bg-white bg-opacity-95 text-gray-900 rounded-3xl shadow-2xl p-10 max-w-4xl w-full">
      <!-- Step 1: Main IN/OUT buttons -->
    <div id="mainButtons" class="flex flex-col items-center gap-8 mb-8">
      <!-- Company Selection -->
      <div class="flex flex-col items-center space-y-4">
        <label for="company" class="text-2xl font-bold text-gray-700">Select Your Department:</label>
        <select name="company" id="company" class="px-6 py-3 text-xl font-semibold border-2 border-gray-300 rounded-xl bg-white shadow-lg focus:outline-none focus:border-blue-500">
          <option value="">-- Select Department --</option>
          <option value="PCL">PCL</option>
          <option value="PUL">PUL</option>
          <option value="PDSL">PDSL</option>
          <option value="PPM">PPM</option>
        </select>
      </div>
  
      
      <!-- IN/OUT Buttons -->
      <div class="flex justify-center gap-12">
        <button id="btnIn" class="px-20 py-8 bg-green-600 hover:bg-green-700 rounded-2xl text-white font-bold text-4xl shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          ‚úÖ IN
        </button>
        <button id="btnOut" class="px-20 py-8 bg-red-600 hover:bg-red-700 rounded-2xl text-white font-bold text-4xl shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          ‚ùå OUT
        </button>
      </div>
    </div>    <!-- Step 2: Enhanced Camera scanning -->
    <div id="cameraContainer" class="flex flex-col items-center space-y-4 hidden">
      <h3 id="scanTitle" class="text-2xl font-bold text-center mb-4">üîç Fast Scanning for IN</h3>
      <div class="relative">
        <video id="video" autoplay playsinline class="rounded-lg shadow w-full max-w-md border-4 border-blue-400"></video>
        <!-- Scanning overlay -->
        <div class="absolute inset-0 border-4 border-green-400 rounded-lg animate-pulse opacity-75 pointer-events-none"></div>
        <!-- Scanning guide lines -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-40 border-2 border-yellow-400 rounded-lg pointer-events-none">
          <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-yellow-400"></div>
          <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-yellow-400"></div>
          <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-yellow-400"></div>
          <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-yellow-400"></div>
        </div>
      </div>      <div class="text-center">
        <div id="scanTimer" class="text-lg font-bold text-green-600 mb-2"></div>
        <div id="scanCounter" class="text-sm font-semibold text-blue-600 mb-2"></div>
        <p class="text-sm text-gray-600 font-semibold">üì∑ Position ID card within the yellow frame</p>
        <p class="text-xs text-green-600">‚ö° LIGHTNING FAST scanning - Instant NIC detection!</p>
      </div>
      <div class="flex gap-4">
        <button id="manualEntryBtn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-lg text-white font-semibold shadow-lg">
          ‚å®Ô∏è Manual Entry
        </button>
        <button id="cancelScanBtn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 rounded-lg text-white font-semibold shadow-lg">
          ‚ùå Cancel
        </button>
      </div>
    </div>

    <!-- Step 3: Manual NIC entry -->
    <div id="manualEntryContainer" class="hidden flex flex-col items-center space-y-4">
      <h3 id="manualTitle" class="text-2xl font-bold text-center mb-4">Enter NIC for IN</h3>
      <input type="text" id="manualNic" placeholder="Enter NIC (e.g., 123456789V)" 
             class="px-4 py-3 border-2 rounded-lg text-center text-lg font-mono tracking-wider w-80" maxlength="12">
      <div class="flex gap-4">
        <button id="confirmManualBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
          Confirm NIC
        </button>
        <button id="cancelManualBtn" class="px-8 py-3 bg-gray-500 hover:bg-gray-600 rounded-lg text-white font-semibold">
          Cancel
        </button>
      </div>
    </div>

    <!-- Step 4: NIC verification and submission -->
    <div id="verificationContainer" class="hidden flex flex-col items-center space-y-6">
      <h3 id="verifyTitle" class="text-2xl font-bold text-center">Verify NIC for IN</h3>
      
      <div class="bg-gray-100 p-6 rounded-lg border-2 border-blue-300">
        <p class="text-lg font-semibold text-gray-700 mb-2">Scanned NIC:</p>
        <p id="scannedNic" class="text-3xl font-mono font-bold text-blue-600 tracking-wider text-center"></p>
      </div>
      
      <p class="text-lg text-center text-gray-700">Is this NIC correct?</p>
      
      <div class="flex gap-6">
        <button id="submitBtn" class="px-12 py-4 bg-green-600 hover:bg-green-700 rounded-xl text-white font-bold text-xl shadow-lg">
          ‚úÖ Yes, Submit
        </button>
        <button id="editNicBtn" class="px-12 py-4 bg-orange-500 hover:bg-orange-600 rounded-xl text-white font-bold text-xl shadow-lg">
          ‚úèÔ∏è Edit NIC
        </button>
        <button id="rescanBtn" class="px-12 py-4 bg-blue-500 hover:bg-blue-600 rounded-xl text-white font-bold text-xl shadow-lg">
          üì∑ Rescan
        </button>
      </div>
    </div>

    <!-- Step 5: NIC Image Capture (for IN actions only) -->
    <div id="nicCaptureContainer" class="hidden flex flex-col items-center space-y-6">
      <h3 class="text-2xl font-bold text-center text-blue-600">üì∏ Capture NIC Images</h3>
      
      <!-- Camera preview for NIC capture -->
      <div class="relative">
        <video id="nicCameraPreview" class="w-80 h-60 border-2 border-blue-300 rounded-lg bg-black hidden" autoplay muted playsinline></video>
        <canvas id="nicCaptureCanvas" class="hidden"></canvas>
      </div>
      
      <!-- Image capture status -->
      <div id="nicCaptureStatus" class="text-center">
        <p id="nicCaptureInstruction" class="text-lg font-semibold text-gray-700 mb-4">
          Step 1: Capture Front Side of NIC
        </p>
        <p class="text-sm text-gray-600 mb-4">Position your NIC card clearly in the camera view</p>
      </div>
      
      <!-- Captured images preview -->
      <div id="nicImagesPreview" class="flex gap-4 hidden">
        <div class="text-center">
          <p class="text-sm font-semibold text-gray-600 mb-2">Front Side</p>
          <img id="frontImagePreview" class="w-32 h-24 border rounded-lg object-cover" />
        </div>
        <div class="text-center">
          <p class="text-sm font-semibold text-gray-600 mb-2">Back Side</p>
          <img id="backImagePreview" class="w-32 h-24 border rounded-lg object-cover" />
        </div>
      </div>
      
      <!-- Action buttons -->
      <div class="flex gap-4">
        <button id="captureNicBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
          üì∑ Capture Image
        </button>
        <button id="retakeNicBtn" class="px-8 py-3 bg-orange-500 hover:bg-orange-600 rounded-lg text-white font-semibold hidden">
          üîÑ Retake
        </button>
        <button id="proceedWithoutImagesBtn" class="px-8 py-3 bg-gray-500 hover:bg-gray-600 rounded-lg text-white font-semibold">
          ‚è≠Ô∏è Skip Images
        </button>
      </div>
      
      <!-- Continue button (shown after both images captured) -->
      <button id="continueAfterCaptureBtn" class="px-12 py-4 bg-green-600 hover:bg-green-700 rounded-xl text-white font-bold text-xl shadow-lg hidden">
        ‚úÖ Continue with Images
      </button>
    </div>

    <!-- Step 6: Success message -->
    <div id="successContainer" class="hidden flex flex-col items-center space-y-4">
      <div class="text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-green-600 mb-4">Success!</h3>
        <p id="successMessage" class="text-xl text-gray-700 mb-6"></p>
        <div class="bg-gray-100 p-4 rounded-lg">
          <p class="text-sm text-gray-600">NIC: <span id="finalNic" class="font-mono font-bold"></span></p>
          <p class="text-sm text-gray-600">Company: <span id="finalCompany" class="font-bold"></span></p>
          <p class="text-sm text-gray-600">Time: <span id="finalTime" class="font-bold"></span></p>
          <p id="workHoursDisplay" class="text-sm text-gray-600 hidden">Work Hours: <span id="finalWorkHours" class="font-bold"></span></p>
        </div>
      </div>
      <button id="newEntryBtn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
        New Entry
      </button>
    </div>

    <!-- Messages -->
    <div id="message" class="mt-8 text-center text-lg font-semibold min-h-[3rem]"></div>
  </div>
  <script>    // DOM elements
    const mainButtons = document.getElementById('mainButtons');
    const btnIn = document.getElementById('btnIn');
    const btnOut = document.getElementById('btnOut');
    const companySelect = document.getElementById('company');
    
    const cameraContainer = document.getElementById('cameraContainer');
    const scanTitle = document.getElementById('scanTitle');
    const video = document.getElementById('video');
    const scanTimer = document.getElementById('scanTimer');
    const scanCounter = document.getElementById('scanCounter');
    const manualEntryBtn = document.getElementById('manualEntryBtn');
    const cancelScanBtn = document.getElementById('cancelScanBtn');
    
    const manualEntryContainer = document.getElementById('manualEntryContainer');
    const manualTitle = document.getElementById('manualTitle');
    const manualNic = document.getElementById('manualNic');
    const confirmManualBtn = document.getElementById('confirmManualBtn');
    const cancelManualBtn = document.getElementById('cancelManualBtn');
    
    const verificationContainer = document.getElementById('verificationContainer');
    const verifyTitle = document.getElementById('verifyTitle');
    const scannedNic = document.getElementById('scannedNic');
    const submitBtn = document.getElementById('submitBtn');
    const editNicBtn = document.getElementById('editNicBtn');
    const rescanBtn = document.getElementById('rescanBtn');
      const successContainer = document.getElementById('successContainer');
    const successMessage = document.getElementById('successMessage');
    const finalNic = document.getElementById('finalNic');
    const finalCompany = document.getElementById('finalCompany');
    const finalTime = document.getElementById('finalTime');
    const finalWorkHours = document.getElementById('finalWorkHours');
    const workHoursDisplay = document.getElementById('workHoursDisplay');
    const newEntryBtn = document.getElementById('newEntryBtn');
    
    // NIC capture elements
    const nicCaptureContainer = document.getElementById('nicCaptureContainer');
    const nicCameraPreview = document.getElementById('nicCameraPreview');
    const nicCaptureCanvas = document.getElementById('nicCaptureCanvas');
    const nicCaptureInstruction = document.getElementById('nicCaptureInstruction');
    const nicImagesPreview = document.getElementById('nicImagesPreview');
    const frontImagePreview = document.getElementById('frontImagePreview');
    const backImagePreview = document.getElementById('backImagePreview');
    const captureNicBtn = document.getElementById('captureNicBtn');
    const retakeNicBtn = document.getElementById('retakeNicBtn');
    const proceedWithoutImagesBtn = document.getElementById('proceedWithoutImagesBtn');
    const continueAfterCaptureBtn = document.getElementById('continueAfterCaptureBtn');
    
    const messageDiv = document.getElementById('message');    // State variables
    let stream = null;
    let intervalId = null;
    let timerIntervalId = null;
    let scanStartTime = null;
    let currentAction = null;
    let currentNic = null;
    let currentCompany = null;
    let scanning = false;
    let scanAttempts = 0; // Global scan attempts counter
    
    // NIC capture state variables
    let nicCameraStream = null;
    let capturedFrontImage = null;
    let capturedBackImage = null;
    let currentCaptureStep = 'front'; // 'front' or 'back'
    let frontImagePath = '';
    let backImagePath = '';    // Company selection logic
    companySelect.addEventListener('change', function() {
      const selectedCompany = this.value;      if (selectedCompany) {
        btnIn.disabled = false;
        btnOut.disabled = false;
        btnIn.classList.remove('opacity-50', 'cursor-not-allowed');
        btnOut.classList.remove('opacity-50', 'cursor-not-allowed');
        currentCompany = selectedCompany;
      } else {
        btnIn.disabled = true;
        btnOut.disabled = true;
        btnIn.classList.add('opacity-50', 'cursor-not-allowed');
        btnOut.classList.add('opacity-50', 'cursor-not-allowed');
        currentCompany = null;
      }
    });

    // Utility functions
    function hideAllContainers() {
      mainButtons.classList.add('hidden');
      cameraContainer.classList.add('hidden');
      manualEntryContainer.classList.add('hidden');
      verificationContainer.classList.add('hidden');
      nicCaptureContainer.classList.add('hidden');
      successContainer.classList.add('hidden');
      messageDiv.textContent = '';
      messageDiv.className = 'mt-8 text-center text-lg font-semibold min-h-[3rem]';
    }

    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
      messageDiv.className = `mt-8 text-center text-lg font-semibold ${colorClass} min-h-[3rem]`;
    }

    function stopCamera() {
      // Complete stop and cleanup
      scanning = false;
      window.scanInProgress = false; // Clear scan flag immediately
      
      // Clear all intervals
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      if (timerIntervalId) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      
      // Stop all camera tracks
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      // Clear video source
      if (video.srcObject) {
        video.srcObject = null;
      }
      
      // Reset timer displays
      if (scanTimer) scanTimer.textContent = '';
      if (scanCounter) scanCounter.textContent = '';
    }

    function startScanTimer() {
      // Clear any existing timer interval
      if (timerIntervalId) {
        clearInterval(timerIntervalId);
      }
      
      timerIntervalId = setInterval(() => {
        if (scanStartTime && scanning) {
          const elapsed = (Date.now() - scanStartTime) / 1000;
          
          // Cap timer at 10 seconds maximum
          const displayTime = Math.min(elapsed, 10.0);
          
          if (scanTimer) {
            // Change color when approaching 10 seconds
            if (displayTime >= 8.0) {
              scanTimer.className = 'text-lg font-bold text-red-600 mb-2';
              scanTimer.textContent = `‚ö†Ô∏è ${displayTime.toFixed(1)}s`;
            } else if (displayTime >= 6.0) {
              scanTimer.className = 'text-lg font-bold text-orange-600 mb-2';
              scanTimer.textContent = `‚è±Ô∏è ${displayTime.toFixed(1)}s`;
            } else {
              scanTimer.className = 'text-lg font-bold text-green-600 mb-2';
              scanTimer.textContent = `‚è±Ô∏è ${displayTime.toFixed(1)}s`;
            }
          }
          
          if (scanCounter) {
            scanCounter.textContent = `üìä Scans: ${scanAttempts}`;
          }
          
          // Stop timer at exactly 10 seconds
          if (elapsed >= 10.0) {
            if (scanTimer) {
              scanTimer.textContent = `üõë 10.0s (MAX)`;
              scanTimer.className = 'text-lg font-bold text-red-700 mb-2';
            }
            clearInterval(timerIntervalId);
            timerIntervalId = null;
          }
        }
      }, 100); // Update every 100ms for smooth timer
    }

    function resetToMainPage() {
      stopCamera();
      hideAllContainers();
      mainButtons.classList.remove('hidden');
      
      // Complete state reset
      currentAction = null;
      currentNic = null;
      currentCompany = null;
      scanAttempts = 0;
      scanStartTime = null;
      
      // Reset form fields
      manualNic.value = '';
      companySelect.value = '';
      
      // Reset button states
      btnIn.disabled = true;
      btnOut.disabled = true;
      btnIn.classList.add('opacity-50', 'cursor-not-allowed');
      btnOut.classList.add('opacity-50', 'cursor-not-allowed');
      
      // Clear any messages
      showMessage('', 'info');
    }    // Step 1: Main button handlers
    btnIn.addEventListener('click', () => startScanning('in'));
    btnOut.addEventListener('click', () => {
      // For OUT actions, first check if NIC is available to validate company
      if (currentNic) {
        validateCompanyForOut();
      } else {
        startScanning('out');
      }
    });

    // Step 2: Start camera scanning
    async function startScanning(action) {
      // Complete reset for fresh scanning
      currentAction = action;
      scanAttempts = 0;
      scanning = false; // Reset scanning state
      
      // Clear any existing timers and intervals
      if (intervalId) clearInterval(intervalId);
      if (timerIntervalId) clearInterval(timerIntervalId);
      
      // Stop any existing camera stream
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      hideAllContainers();
      cameraContainer.classList.remove('hidden');
      
      // Reset timer displays
      if (scanTimer) scanTimer.textContent = '';
      if (scanCounter) scanCounter.textContent = '';
      
      scanTitle.textContent = `üîç Lightning Fast Scanning for ${action.toUpperCase()}`;
      scanTitle.className = `text-2xl font-bold text-center mb-4 ${action === 'in' ? 'text-green-600' : 'text-red-600'}`;
      
      showMessage('Starting camera...', 'info');

      try {
        // Request fresh camera stream
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          } 
        });
        
        video.srcObject = stream;
        
        // Wait for video to be ready
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });
        
        // Start scanning after video is ready
        scanning = true;
        scanStartTime = Date.now(); // Reset start time
        startScanTimer();

        showMessage(`üîç ENHANCED SCANNING for ${action.toUpperCase()}... Hold ID card steady in yellow frame`, action === 'in' ? 'success' : 'error');

        // ENHANCED scanning - every 200ms for better reliability
        intervalId = setInterval(captureAndScan, 200);
        
        // Start scanning quickly
        setTimeout(captureAndScan, 150);

        // Global 10-second timeout for entire scanning process
        setTimeout(() => {
          if (scanning) {
            stopCamera();
            showMessage('‚è∞ Scanning timeout after 10 seconds. Please try again with better lighting or angle.', 'warning');
            resetToMainPage();
          }
        }, 10000); // 10 seconds maximum scanning time

      } catch (error) {
        showMessage('Camera access denied: ' + error.message, 'error');
        resetToMainPage();
      }
    }

    // Enhanced capture frame and send for scanning
    async function captureAndScan() {
      // Double-check scanning state and prevent multiple simultaneous requests
      if (!video.videoWidth || !scanning) return;
      
      // Prevent multiple simultaneous scan requests
      if (window.scanInProgress) return;
      window.scanInProgress = true;

      scanAttempts++;
      // Update counter immediately
      if (scanCounter) {
        scanCounter.textContent = `üìä Scans: ${scanAttempts}`;
      }
      
      showMessage(`‚ö° SCAN ${scanAttempts}... ${currentAction.toUpperCase()} mode - Hold ID steady!`, 'info');

      // Create canvas with optimal size
      const canvas = document.createElement('canvas');
      const maxSize = 800; // Limit canvas size for speed
      const aspectRatio = video.videoWidth / video.videoHeight;
      
      if (video.videoWidth > maxSize) {
        canvas.width = maxSize;
        canvas.height = maxSize / aspectRatio;
      } else {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
      
      const ctx = canvas.getContext('2d');
      
      // Enhanced image capture with optimized quality
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('id_card', blob, `scan_${Date.now()}.jpg`);

        try {
          const startTime = Date.now();
          const res = await fetch('/scan', {
            method: 'POST',
            body: formData,
            // Enhanced timeout for better accuracy
            signal: AbortSignal.timeout(3000)  // 3 seconds for thorough extraction
          });

          const data = await res.json();
          const extractionTime = (Date.now() - startTime) / 1000;

          if (res.ok && data.success) {
            // IMMEDIATE SUCCESS FEEDBACK - Stop scanning first!
            scanning = false; // Stop scanning immediately
            clearInterval(intervalId); // Clear scan interval
            
            stopCamera();
            currentNic = data.nic;
            
            // Show big success message with NIC and timing
            const totalTime = ((Date.now() - scanStartTime) / 1000).toFixed(1);
            showMessage(`üéâ SUCCESS! NIC: ${data.nic} (Found in ${totalTime}s)`, 'success');
            
            // Add visual success feedback
            if (scanTimer) {
              scanTimer.textContent = `‚úÖ Complete: ${totalTime}s`;
              scanTimer.className = 'text-lg font-bold text-green-600 mb-2';
            }
            if (scanCounter) {
              scanCounter.textContent = `üéØ Success: ${scanAttempts} scans`;
              scanCounter.className = 'text-sm font-semibold text-green-600 mb-2';
            }
            
            // INSTANT transition to verification - no delay!
            setTimeout(() => {
              showVerification();
            }, 500); // Reduced from 1200ms to 500ms for faster response
            
            return; // Exit immediately - no more scanning needed!
            
          } else {
            // Enhanced feedback for continuous scanning with better guidance
            if (scanAttempts >= 30) {
              showMessage('üîç Long scanning... Try different lighting or hold card closer', 'warning');
            } else if (scanAttempts >= 20) {
              showMessage('üì± Try holding card flat and steady in the yellow frame', 'info');
            } else if (scanAttempts >= 15) {
              showMessage('üí° Ensure good lighting - avoid shadows on the card', 'info');
            } else if (scanAttempts >= 10) {
              showMessage(`üì∑ Scanning... ${scanAttempts} attempts - keep card steady`, 'info');
            } else if (scanAttempts >= 5) {
              showMessage(`üîç Looking for NIC... ${scanAttempts} scans`, 'info');
            } else {
              showMessage(`üîç Scanning... ${scanAttempts}`, 'info');
            }
          }
        } catch (err) {
          if (err.name === 'TimeoutError') {
            showMessage(`‚è±Ô∏è Processing timeout - adjusting and retrying...`, 'warning');
          } else if (err.name === 'NetworkError') {
            showMessage(`üì∂ Network issue - retrying...`, 'warning');
          } else {
            showMessage(`üîÑ Scan error - continuing...`, 'info');
          }
          // Continue scanning even on errors
        } finally {
          // Clear the scan flag to allow next scan
          window.scanInProgress = false;
        }
      }, 'image/jpeg', 0.9);  // Higher quality for better OCR: 0.9 instead of 0.8
    }

    // Camera control buttons
    manualEntryBtn.addEventListener('click', () => {
      stopCamera();
      hideAllContainers();
      manualEntryContainer.classList.remove('hidden');
      manualTitle.textContent = `Enter NIC for ${currentAction.toUpperCase()}`;
      manualTitle.className = `text-2xl font-bold text-center mb-4 ${currentAction === 'in' ? 'text-green-600' : 'text-red-600'}`;
      manualNic.focus();
    });

    cancelScanBtn.addEventListener('click', resetToMainPage);

    // Step 3: Manual NIC entry
    confirmManualBtn.addEventListener('click', () => {
      const nic = manualNic.value.trim().toUpperCase();
      if (!nic) {
        showMessage('Please enter a valid NIC.', 'error');
        return;
      }
      
      // Validate NIC format
      if (!/^\d{9}[VX]$|^\d{12}$/.test(nic)) {
        showMessage('Invalid NIC format. Please enter a valid NIC (e.g., 123456789V)', 'error');
        return;
      }
      
      currentNic = nic;
      showVerification();
    });

    cancelManualBtn.addEventListener('click', () => {
      manualNic.value = '';
      startScanning(currentAction);
    });

    // Allow Enter key in manual input
    manualNic.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        confirmManualBtn.click();
      }
    });    // Step 4: Show verification
    function showVerification() {
      hideAllContainers();
      verificationContainer.classList.remove('hidden');
      
      verifyTitle.textContent = `Verify NIC for ${currentAction.toUpperCase()}`;
      verifyTitle.className = `text-2xl font-bold text-center ${currentAction === 'in' ? 'text-green-600' : 'text-red-600'}`;
      
      // Different message for IN vs OUT
      if (currentAction === 'out') {
        showMessage('‚úÖ No additional images required for check-out. Please verify the NIC is correct.', 'success');
      } else {
        showMessage('Please verify the NIC is correct before submitting.', 'info');
      }
      
      scannedNic.textContent = currentNic;
    }    // Verification button handlers
    submitBtn.addEventListener('click', async () => {
      showMessage('Checking NIC status...', 'info');
      
      try {
        // First, check if this NIC needs images (for IN actions)
        const statusRes = await fetch('/check_nic_status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            nic: currentNic,
            action: currentAction
          })
        });
        
        const statusData = await statusRes.json();
        
        if (!statusData.success) {
          showMessage(`‚ùå Error checking NIC status: ${statusData.message}`, 'error');
          return;
        }
        
        // For OUT actions, proceed directly without NIC image capture
        if (currentAction === 'out') {
          showMessage('Submitting check-out...', 'info');
          
          const res = await fetch('/record_attendance', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: currentAction.toUpperCase(),
              nic: currentNic,
              company: currentCompany,
              front_image_path: '',  // No images required for OUT
              back_image_path: ''    // No images required for OUT
            })
          });

          const data = await res.json();

          if (res.ok && data.status === 'success') {
            showSuccess({
              success: true,
              message: data.message,
              nic: currentNic,
              company: currentCompany,
              time: data.time,
              work_hours: data.work_hours
            });
          } else {
            showMessage(data.message || 'Submission failed.', data.status === 'warning' ? 'info' : 'error');
          }
        } else {
          // For IN actions, check if images are needed
          if (statusData.needs_images) {
            // First-time user or user without complete images - go to capture
            if (statusData.is_first_time) {
              showMessage('üéâ Welcome to Printcare! Please capture your NIC images for your first check-in.', 'info');
            } else {
              showMessage('üì∏ NIC images needed for check-in. Please capture front and back images.', 'info');
            }
            showNICCapture();
          } else {
            // Returning user with existing images - proceed directly
            showMessage('‚úÖ Returning user detected. Processing check-in...', 'success');
            
            const res = await fetch('/record_attendance', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                action: currentAction.toUpperCase(),
                nic: currentNic,
                company: currentCompany,
                front_image_path: '',  // Use existing images from database/disk
                back_image_path: ''    // Use existing images from database/disk
              })
            });

            const data = await res.json();

            if (res.ok && data.status === 'success') {
              showSuccess({
                success: true,
                message: data.message,
                nic: currentNic,
                company: currentCompany,
                time: data.time,
                is_first_time: data.is_first_time
              });
            } else {
              showMessage(data.message || 'Submission failed.', 'error');
            }
          }
        }
      } catch (err) {
        console.error('Submit error:', err);
        showMessage('Error connecting to server.', 'error');
      }
    });

    editNicBtn.addEventListener('click', () => {
      hideAllContainers();
      manualEntryContainer.classList.remove('hidden');
      manualTitle.textContent = `Edit NIC for ${currentAction.toUpperCase()}`;
      manualTitle.className = `text-2xl font-bold text-center mb-4 ${currentAction === 'in' ? 'text-green-600' : 'text-red-600'}`;
      manualNic.value = currentNic;
      manualNic.focus();
      manualNic.select();
    });    rescanBtn.addEventListener('click', () => {
      // Complete reset for rescanning
      currentNic = null;
      scanAttempts = 0;
      
      // Clear any existing timers
      if (timerIntervalId) clearInterval(timerIntervalId);
      if (intervalId) clearInterval(intervalId);
      
      // Reset timer displays
      if (scanTimer) scanTimer.textContent = '';
      if (scanCounter) scanCounter.textContent = '';
      
      // Start fresh scanning
      startScanning(currentAction);
    });

    // Step 5: Show success
    function showSuccess(data) {
      hideAllContainers();
      successContainer.classList.remove('hidden');
      
      // Special styling for first-time users
      if (data.is_first_time) {
        successContainer.querySelector('h3').textContent = 'üéâ Welcome to Printcare!';
        successContainer.querySelector('h3').className = 'text-2xl font-bold text-purple-600 mb-4';
        successContainer.querySelector('.text-6xl').textContent = 'üéä';
      } else {
        successContainer.querySelector('h3').textContent = 'Success!';
        successContainer.querySelector('h3').className = 'text-2xl font-bold text-green-600 mb-4';
        successContainer.querySelector('.text-6xl').textContent = 'üéâ';
      }
      
      successMessage.textContent = data.message;
      finalNic.textContent = data.nic;
      finalCompany.textContent = data.company;
      finalTime.textContent = data.time;
      
      // Show work hours for OUT actions
      if (data.work_hours) {
        finalWorkHours.textContent = data.work_hours;
        workHoursDisplay.classList.remove('hidden');
      } else {
        workHoursDisplay.classList.add('hidden');
      }
      
      // Auto return to main page after 8 seconds
      setTimeout(() => {
        resetToMainPage();
      }, 8000);
    }

    newEntryBtn.addEventListener('click', resetToMainPage);

    // Close logout message
    function closeLogoutMessage() {
      const logoutMessage = document.getElementById('logoutMessage');
      if (logoutMessage) {
        logoutMessage.style.transition = 'opacity 0.3s ease-out';
        logoutMessage.style.opacity = '0';
        setTimeout(function() {
          logoutMessage.remove();
        }, 300);
      }
    }

    // Auto-hide logout message after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const logoutMessage = document.getElementById('logoutMessage');
      if (logoutMessage) {
        setTimeout(function() {
          logoutMessage.style.transition = 'opacity 0.5s ease-out';
          logoutMessage.style.opacity = '0';
          setTimeout(function() {
            logoutMessage.remove();
          }, 500);
        }, 5000);
      }
    });

    // ========== NIC IMAGE CAPTURE FUNCTIONS ==========
    
    function showNICCapture() {
      hideAllContainers();
      nicCaptureContainer.classList.remove('hidden');
      
      // Reset capture state
      currentCaptureStep = 'front';
      capturedFrontImage = null;
      capturedBackImage = null;
      frontImagePath = '';
      backImagePath = '';
      
      // Reset UI
      nicImagesPreview.classList.add('hidden');
      continueAfterCaptureBtn.classList.add('hidden');
      retakeNicBtn.classList.add('hidden');
      captureNicBtn.classList.remove('hidden');
      
      updateCaptureInstruction();
      initializeNICCamera();
    }
    
    async function initializeNICCamera() {
      try {
        if (nicCameraStream) {
          nicCameraStream.getTracks().forEach(track => track.stop());
        }
        
        nicCameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'environment'
          }
        });
        
        nicCameraPreview.srcObject = nicCameraStream;
        nicCameraPreview.classList.remove('hidden');
        showMessage('üì∏ Camera ready for NIC capture', 'success');
        
      } catch (error) {
        console.error('Camera access error:', error);
        showMessage('‚ùå Camera access failed. You can proceed without images.', 'error');
      }
    }
    
    function updateCaptureInstruction() {
      if (currentCaptureStep === 'front') {
        nicCaptureInstruction.textContent = 'Step 1: Capture Front Side of NIC';
        captureNicBtn.innerHTML = 'üì∑ Capture Front';
      } else {
        nicCaptureInstruction.textContent = 'Step 2: Capture Back Side of NIC';
        captureNicBtn.innerHTML = 'üì∑ Capture Back';
      }
    }
    
    function stopNICCamera() {
      if (nicCameraStream) {
        nicCameraStream.getTracks().forEach(track => track.stop());
        nicCameraStream = null;
      }
      nicCameraPreview.classList.add('hidden');
    }
    
    async function captureNICImage() {
      if (!nicCameraStream) {
        showMessage('‚ùå Camera not available', 'error');
        return;
      }
      
      try {
        const canvas = nicCaptureCanvas;
        const context = canvas.getContext('2d');
        
        canvas.width = nicCameraPreview.videoWidth;
        canvas.height = nicCameraPreview.videoHeight;
        
        context.drawImage(nicCameraPreview, 0, 0);
        
        // Convert to blob
        canvas.toBlob(async (blob) => {
          if (blob) {
            await saveNICImage(blob, currentCaptureStep);
          }
        }, 'image/jpeg', 0.8);
        
      } catch (error) {
        console.error('Image capture error:', error);
        showMessage('‚ùå Failed to capture image', 'error');
      }
    }
    
    async function saveNICImage(imageBlob, imageType) {
      try {
        showMessage(`üíæ Saving ${imageType} image...`, 'info');
        
        const formData = new FormData();
        formData.append('nic_image', imageBlob, `${currentNic}_${imageType}.jpg`);
        formData.append('image_type', imageType);
        formData.append('nic_number', currentNic);
        formData.append('timestamp', Date.now().toString());
        
        const response = await fetch('/save_nic_image', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store image paths
          if (imageType === 'front') {
            capturedFrontImage = imageBlob;
            frontImagePath = data.filepath;
            frontImagePreview.src = URL.createObjectURL(imageBlob);
          } else {
            capturedBackImage = imageBlob;
            backImagePath = data.filepath;
            backImagePreview.src = URL.createObjectURL(imageBlob);
          }
          
          showMessage(`‚úÖ ${imageType.charAt(0).toUpperCase() + imageType.slice(1)} image saved successfully`, 'success');
          
          // Move to next step
          if (currentCaptureStep === 'front') {
            currentCaptureStep = 'back';
            updateCaptureInstruction();
            nicImagesPreview.classList.remove('hidden');
          } else {
            // Both images captured
            stopNICCamera();
            nicImagesPreview.classList.remove('hidden');
            captureNicBtn.classList.add('hidden');
            continueAfterCaptureBtn.classList.remove('hidden');
            retakeNicBtn.classList.remove('hidden');
            showMessage('‚úÖ Both NIC images captured successfully!', 'success');
          }
          
        } else {
          showMessage(`‚ùå Failed to save ${imageType} image: ${data.message}`, 'error');
        }
        
      } catch (error) {
        console.error('Save image error:', error);
        showMessage(`‚ùå Error saving ${imageType} image`, 'error');
      }
    }
    
    async function submitAttendanceWithImages() {
      try {
        showMessage('üìù Submitting attendance with NIC images...', 'info');
        
        const response = await fetch('/record_attendance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: currentAction.toUpperCase(),
            nic: currentNic,
            company: currentCompany,
            front_image_path: frontImagePath,
            back_image_path: backImagePath
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
          stopNICCamera();
          showSuccess({
            success: true,
            message: data.message,
            nic: currentNic,
            company: currentCompany,
            time: data.time
          });
        } else {
          showMessage(data.message || 'Submission failed.', 'error');
        }
        
      } catch (error) {
        console.error('Submit attendance error:', error);
        showMessage('‚ùå Error submitting attendance', 'error');
      }
    }
    
    async function submitAttendanceWithoutImages() {
      try {
        showMessage('üìù Submitting attendance without images...', 'info');
        
        const response = await fetch('/record_attendance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: currentAction.toUpperCase(),
            nic: currentNic,
            company: currentCompany,
            front_image_path: '',
            back_image_path: ''
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
          stopNICCamera();
          showSuccess({
            success: true,
            message: data.message,
            nic: currentNic,
            company: currentCompany,
            time: data.time
          });
        } else {
          showMessage(data.message || 'Submission failed.', 'error');
        }
        
      } catch (error) {
        console.error('Submit attendance error:', error);
        showMessage('‚ùå Error submitting attendance', 'error');
      }
    }
    
    // ========== NIC CAPTURE EVENT LISTENERS ==========
    
    captureNicBtn.addEventListener('click', captureNICImage);
    
    retakeNicBtn.addEventListener('click', () => {
      // Reset and restart capture process
      currentCaptureStep = 'front';
      capturedFrontImage = null;
      capturedBackImage = null;
      frontImagePath = '';
      backImagePath = '';
      
      nicImagesPreview.classList.add('hidden');
      continueAfterCaptureBtn.classList.add('hidden');
      retakeNicBtn.classList.add('hidden');
      captureNicBtn.classList.remove('hidden');
      
      updateCaptureInstruction();
      initializeNICCamera();
    });
    
    proceedWithoutImagesBtn.addEventListener('click', () => {
      stopNICCamera();
      submitAttendanceWithoutImages();
    });
    
    continueAfterCaptureBtn.addEventListener('click', () => {
      submitAttendanceWithImages();
    });

    // Company validation for OUT actions
    async function validateCompanyForOut() {
      if (!currentNic) {
        startScanning('out');
        return;
      }
      
      try {
        showMessage('Checking active companies...', 'info');
        
        const response = await fetch('/get_nic_company', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            nic: currentNic,
            action: 'OUT'
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.has_active_record) {
          const activeCompanies = data.active_companies;
          const currentSelected = companySelect.value;
          
          // Check if current selection matches any active company
          const matchingCompany = activeCompanies.find(comp => comp.company === currentSelected);
          
          if (matchingCompany) {
            // Correct company selected, proceed
            showMessage(`‚úÖ Correct company selected: ${matchingCompany.display_company}. Processing OUT...`, 'success');
            startScanning('out');
          } else {
            // Wrong company or no company selected - show all active companies
            if (activeCompanies.length === 1) {
              // Single active company - auto-select it
              const activeComp = activeCompanies[0];
              showMessage(`‚ö†Ô∏è Please select company: ${activeComp.display_company} (checked IN at ${activeComp.in_time})`, 'error');
              
              // Auto-select the correct company
              companySelect.value = activeComp.company;
              currentCompany = activeComp.company;
              
              // Enable buttons if they were disabled
              btnIn.disabled = false;
              btnOut.disabled = false;
              btnIn.classList.remove('opacity-50', 'cursor-not-allowed');
              btnOut.classList.remove('opacity-50', 'cursor-not-allowed');
              
              setTimeout(() => {
                showMessage(`Company auto-selected: ${activeComp.display_company}. Click OUT again to proceed.`, 'success');
              }, 2000);
            } else {
              // Multiple active companies - show selection guidance
              const companyList = activeCompanies.map(comp => 
                `${comp.display_company} (IN: ${comp.in_time})`
              ).join(', ');
              
              showMessage(`‚ö†Ô∏è Multiple active companies found. Please select: ${companyList}`, 'error');
              
              // Don't auto-select, let user choose
              setTimeout(() => {
                showMessage(`You have ${activeCompanies.length} active check-ins. Select the company you want to check OUT from.`, 'info');
              }, 3000);
            }
          }
        } else {
          // No active record found
          showMessage(data.message || 'No active IN records found for OUT action.', 'error');
          startScanning('out'); // Still allow scanning to get proper error
        }
        
      } catch (error) {
        console.error('Company validation error:', error);
        showMessage('Error validating company. Proceeding with OUT...', 'error');
        startScanning('out');
      }
    }

  </script>
</body>
</html>
